<script>
const URL_APPS = "https://script.google.com/macros/s/AKfycbwwl6i89bMXh8TNd3Kk7iFzZuUcwOdqzLKqZ5geg2r7FIurKOoj102twjhSlXDRpsw7Fw/exec";

/* =======================
   USUÁRIO
======================= */
const emailUsuario = sessionStorage.getItem("emailUsuario");
const tipoUsuario = sessionStorage.getItem("tipoUsuario");

if(!emailUsuario || !tipoUsuario){
    alert("Acesso inválido.");
    window.location.href = "index.html";
}

document.getElementById("infoUsuario").innerText =
`Usuário: ${emailUsuario} | Perfil: ${tipoUsuario === "admin" ? "Administrador" : "Coordenador"}`;

if(tipoUsuario !== "admin"){
    document.getElementById("btnAdicionar").style.display = "none";
}

/* =======================
   DADOS
======================= */
let bolsistas = JSON.parse(localStorage.getItem("bolsistas")) || [];

/* =======================
   TABELA
======================= */
function renderTabela(){
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    bolsistas.forEach((b,i)=>{
        if(tipoUsuario !== "admin" && b.coordenador !== emailUsuario) return;

        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td>${inputTexto(i,"campus")}</td>
        <td>${inputTexto(i,"nome")}</td>
        <td>${inputTexto(i,"matricula")}</td>
        <td>${inputTexto(i,"setor")}</td>
        <td>${inputData(i,"vigenciaInicio")}</td>
        <td>${inputData(i,"vigenciaFim")}</td>
        <td>${inputTexto(i,"coordenador")}</td>
        ${mesesHTML(b,i)}
        <td>${inputTexto(i,"justificativa",true)}</td>
        <td>
            <input type="file" onchange="uploadArquivo(event,${i})">
            ${b.arquivoNome ? `<div>${b.arquivoNome}</div>` : ""}
        </td>
        <td>${tipoUsuario==="admin" ? `<button onclick="remover(${i})">Remover</button>` : ""}</td>
        `;
        tbody.appendChild(tr);
    });

    salvar();
}

function inputTexto(i,campo,sempreEditavel=false){
    const editavel = tipoUsuario==="admin" || sempreEditavel;
    return editavel
        ? `<input type="text" value="${bolsistas[i][campo]||""}" onchange="atualizar(${i},'${campo}',this.value)">`
        : (bolsistas[i][campo]||"");
}

function inputData(i,campo){
    return tipoUsuario==="admin"
        ? `<input type="date" value="${bolsistas[i][campo]||""}" onchange="atualizar(${i},'${campo}',this.value)">`
        : (bolsistas[i][campo]||"");
}

function mesesHTML(b,i){
    const meses = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
    return meses.map(m=>`
        <td>
            <select onchange="atualizar(${i},'${m}',this.value)">
                <option value=""> </option>
                <option value="SIM" ${b[m]==="SIM"?"selected":""}>SIM</option>
                <option value="NÃO" ${b[m]==="NÃO"?"selected":""}>NÃO</option>
            </select>
        </td>
    `).join("");
}

/* =======================
   CRUD
======================= */
function atualizar(i,campo,valor){
    bolsistas[i][campo] = valor;
    salvar();
}

function adicionarBolsista(){
    bolsistas.push({
        campus:"",
        nome:"",
        matricula:"",
        setor:"",
        coordenador:"",
        vigenciaInicio:"",
        vigenciaFim:"",
        Jan:"",Fev:"",Mar:"",Abr:"",Mai:"",Jun:"",
        Jul:"",Ago:"",Set:"",Out:"",Nov:"",Dez:"",
        justificativa:"",
        arquivoBase64:"",
        arquivoNome:""
    });
    renderTabela();
}

function remover(i){
    if(confirm("Remover bolsista?")){
        bolsistas.splice(i,1);
        renderTabela();
    }
}

function salvar(){
    localStorage.setItem("bolsistas", JSON.stringify(bolsistas));
}

/* =======================
   UPLOAD
======================= */
function uploadArquivo(e,i){
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = ()=>{
        bolsistas[i].arquivoBase64 = reader.result.split(",")[1];
        bolsistas[i].arquivoNome = file.name;
        salvar();
        renderTabela();
    };
    reader.readAsDataURL(file);
}

/* =======================
   ENVIO
======================= */
function enviarPlanilha(){
    fetch(URL_APPS,{
        method:"POST",
        body: JSON.stringify(bolsistas)
    })
    .then(r=>r.json())
    .then(d=>{
        if(d.status==="ok") alert("Dados enviados com sucesso!");
        else alert(d.mensagem);
    })
    .catch(()=>alert("Erro de conexão"));
}

renderTabela();
</script>
