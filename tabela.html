<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Frequ√™ncia de Bolsistas</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 20px;
}
.container {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    max-width: 1400px;
    margin: auto;
}
h2 { margin-top: 0; }
table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
th, td {
    border: 1px solid #ccc;
    padding: 5px;
    text-align: center;
}
th { background: #eee; }
input, select { width: 100%; font-size: 12px; }
button {
    padding: 6px 12px;
    margin-right: 5px;
    cursor: pointer;
}
.hidden { display: none; }
</style>
</head>

<body>
<div class="container">
<h2>Sistema de Frequ√™ncia de Bolsistas</h2>
<div id="infoUsuario"></div>

<br>

<button id="btnAdicionar">‚ûï Adicionar Bolsista</button>
<button id="btnSalvar">üíæ Salvar</button>
<button id="btnEnviar">üì§ Enviar Planilha</button>

<br><br>

<table>
<thead>
<tr>
<th>Campus</th>
<th>Nome</th>
<th>Matr√≠cula</th>
<th>Setor</th>
<th>In√≠cio</th>
<th>Fim</th>
<th>Email Coordenador</th>
<th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th>
<th>Mai</th><th>Jun</th><th>Jul</th><th>Ago</th>
<th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
<th>Justificativa</th>
<th>Arquivo</th>
<th>A√ß√µes</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

/* ================= CONFIG ================= */
const URL_APPS = "https://script.google.com/macros/s/AKfycbwwl6i89bMXh8TNd3Kk7iFzZuUcwOdqzLKqZ5geg2r7FIurKOoj102twjhSlXDRpsw7Fw/exec";
const meses = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];

/* ================= USU√ÅRIO ================= */
const emailUsuario = sessionStorage.getItem("emailUsuario");
const tipoUsuario = sessionStorage.getItem("tipoUsuario");

if (!emailUsuario || !tipoUsuario) {
    alert("Acesso inv√°lido");
    window.location.href = "index.html";
    return;
}

document.getElementById("infoUsuario").innerText =
`Usu√°rio: ${emailUsuario} | Perfil: ${tipoUsuario}`;

if (tipoUsuario !== "admin") {
    document.getElementById("btnAdicionar").classList.add("hidden");
}

/* ================= DADOS ================= */
let bolsistas = JSON.parse(localStorage.getItem("bolsistas")) || [];

/* ================= FUN√á√ïES ================= */
function salvar() {
    localStorage.setItem("bolsistas", JSON.stringify(bolsistas));
}

function renderTabela() {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    bolsistas.forEach((b, i) => {
        if (tipoUsuario !== "admin" && b.coordenador !== emailUsuario) return;

        const tr = document.createElement("tr");

        tr.innerHTML = `
        <td><input value="${b.campus||""}" onchange="atualizar(${i},'campus',this.value)"></td>
        <td><input value="${b.nome||""}" onchange="atualizar(${i},'nome',this.value)"></td>
        <td><input value="${b.matricula||""}" onchange="atualizar(${i},'matricula',this.value)"></td>
        <td><input value="${b.setor||""}" onchange="atualizar(${i},'setor',this.value)"></td>
        <td><input type="date" value="${b.inicio||""}" onchange="atualizar(${i},'inicio',this.value)"></td>
        <td><input type="date" value="${b.fim||""}" onchange="atualizar(${i},'fim',this.value)"></td>
        <td><input value="${b.coordenador||""}" onchange="atualizar(${i},'coordenador',this.value)"></td>
        ${meses.map(m => `
        <td>
            <select onchange="atualizar(${i},'${m}',this.value)">
                <option value=""></option>
                <option ${b[m]==="SIM"?"selected":""}>SIM</option>
                <option ${b[m]==="N√ÉO"?"selected":""}>N√ÉO</option>
            </select>
        </td>`).join("")}
        <td><input value="${b.justificativa||""}" onchange="atualizar(${i},'justificativa',this.value)"></td>
        <td><input type="file" onchange="uploadArquivo(event,${i})"></td>
        <td><button onclick="remover(${i})">‚ùå</button></td>
        `;

        tbody.appendChild(tr);
    });

    salvar();
}

window.atualizar = (i,c,v) => { bolsistas[i][c]=v; salvar(); };

window.remover = (i) => {
    if(confirm("Remover bolsista?")) {
        bolsistas.splice(i,1);
        renderTabela();
    }
};

window.uploadArquivo = (e,i) => {
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = () => {
        bolsistas[i].arquivoBase64 = reader.result.split(",")[1];
        bolsistas[i].arquivoNome = file.name;
        salvar();
    };
    reader.readAsDataURL(file);
};

/* ================= BOT√ïES ================= */
document.getElementById("btnAdicionar").onclick = () => {
    bolsistas.push({});
    renderTabela();
};

document.getElementById("btnSalvar").onclick = salvar;

document.getElementById("btnEnviar").onclick = () => {
    fetch(URL_APPS, {
        method: "POST",
        body: JSON.stringify(bolsistas)
    })
    .then(r=>r.json())
    .then(d=>alert(d.status==="ok"?"Enviado com sucesso":"Erro"))
    .catch(()=>alert("Erro de conex√£o"));
};

/* ================= INIT ================= */
renderTabela();

});
</script>
</body>
</html>
